<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Makongeni Green Nairobi Welfare</title>

    <!-- Beautiful Green Leaf + Nairobi Skyline Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2328a745'/%3E%3Cstop offset='100%25' stop-color='%231e7e34'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23grad)' d='M50 15c-10 0-15 8-20 15-5-7-10-15-20-15 0 20 15 35 20 45 5-10 20-25 20-45zm0 0c10 0 15 8 20 15 5-7 10-15 20-15 0 20-15 35-20 45-5-10-20-25-20-45z'/%3E%3Crect x='45' y='65' width='10' height='20' fill='%2328a745' rx='1'/%3E%3C/svg%3E" />

    <!-- Apple Touch Icon (for iOS devices) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%2328a745' rx='36'/%3E%3Cpath fill='white' d='M90 45c-12 0-18 10-24 18-6-8-12-18-24-18 0 24 18 42 24 54 6-12 24-30 24-54zm0 0c12 0 18 10 24 18 6-8 12-18 24-18 0 24-18 42-24 54-6-12-24-30-24-54z'/%3E%3Crect x='84' y='108' width='12' height='30' fill='white' rx='2'/%3E%3C/svg%3E">

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Courier Prime', monospace; font-size: 16px; background-color: #f8f9fa; }
        .navbar { background-color: #28a745 !important; }
        .navbar-brand, .nav-link { color: white !important; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #28a745; }
        .table-responsive { overflow-x: auto; }
        .alert { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        input:invalid { border-color: red; }
        .negative { color: #dc3545 !important; font-weight: bold; }
        .positive { color: #28a745 !important; }
        .loading { text-align: center; padding: 20px; }
        .init-error {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #dc3545;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
        }
        .dashboard-card { cursor: pointer; transition: transform 0.2s; }
        .dashboard-card:hover { transform: scale(1.05); }
        .dashboard-icon { color: #28a745; }
        .sortable { cursor: pointer; }
        .sortable::after { content: ' \25B4'; opacity: 0.5; }
        .sortable.asc::after { content: ' \25B2'; opacity: 1; }
        .sortable.desc::after { content: ' \25BC'; opacity: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- SHA256 for password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.10.1/src/sha256.min.js"></script>
    <!-- XLSX for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK (Modular Imports) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager, collection, getDocs, setDoc, addDoc, deleteDoc, query, where, writeBatch, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        window.firebase = { initializeApp, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, getAuth, collection, getDocs, setDoc, addDoc, deleteDoc, query, where, writeBatch, doc, updateDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxs__5wmHC3qjd9s0KdC12IkV5huLz52o",
            authDomain: "ongeniwelfareworking.firebaseapp.com",
            projectId: "ongeniwelfareworking",
            storageBucket: "ongeniwelfareworking.firebasestorage.app",
            messagingSenderId: "131650440596",
            appId: "1:131650440596:web:c021c95e1cac6217551381",
            measurementId: "G-F8F3EWSE3S"
        };

        // Global database instance
        let db = null;
        let isFirebaseInitialized = false;
        let initializationPromise = null;

        // Initialize Firebase with retry logic
        const initializeFirebase = async () => {
            if (isFirebaseInitialized) return true;
            if (initializationPromise) return initializationPromise;
            initializationPromise = (async () => {
                try {
                    if (!firebaseConfig.apiKey) throw new Error("Firebase configuration is missing or invalid.");
                    const app = firebase.initializeApp(firebaseConfig);
                    db = firebase.initializeFirestore(app, {
                        localCache: firebase.persistentLocalCache({
                            tabManager: firebase.persistentMultipleTabManager()
                        })
                    });
                    isFirebaseInitialized = true;
                    console.log("Firebase initialized successfully");
                    return true;
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    isFirebaseInitialized = false;
                    initializationPromise = null;
                    return false;
                }
            })();
            return initializationPromise;
        };

        // Month names
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Firestore helpers
        const loadData = async (collectionName, defaultValue = []) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const collRef = firebase.collection(db, collectionName);
                const snapshot = await firebase.getDocs(collRef);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error(`Error loading ${collectionName}:`, e);
                return defaultValue;
            }
        };

        const saveData = async (collectionName, data) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const batch = firebase.writeBatch(db);
                data.forEach(item => {
                    const docRef = firebase.doc(firebase.collection(db, collectionName));
                    batch.set(docRef, item);
                });
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error saving ${collectionName}:`, e);
                throw e;
            }
        };

        const addData = async (collectionName, item) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                await firebase.addDoc(firebase.collection(db, collectionName), item);
                return true;
            } catch (e) {
                console.error(`Error adding to ${collectionName}:`, e);
                throw e;
            }
        };

        const updateData = async (collectionName, id, updates) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const docRef = firebase.doc(db, collectionName, id);
                await firebase.updateDoc(docRef, updates);
                return true;
            } catch (e) {
                console.error(`Error updating in ${collectionName}:`, e);
                throw e;
            }
        };

        const deleteData = async (collectionName, queryField, queryValue) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const collRef = firebase.collection(db, collectionName);
                const q = firebase.query(collRef, firebase.where(queryField, '==', queryValue));
                const snapshot = await firebase.getDocs(q);
                const batch = firebase.writeBatch(db);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error deleting from ${collectionName}:`, e);
                throw e;
            }
        };

        const deleteByIds = async (collectionName, ids) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const batch = firebase.writeBatch(db);
                ids.forEach(id => {
                    const docRef = firebase.doc(firebase.collection(db, collectionName), id);
                    batch.delete(docRef);
                });
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error deleting from ${collectionName}:`, e);
                throw e;
            }
        };

        // Utils for date parsing
        const getYear = (date) => date ? parseInt(date.split('-')[0], 10) : 0;
        const getMonth = (date) => date ? parseInt(date.split('-')[1], 10) : 0;

        // Compute member shares from earnings (proportional based on contributing months)
        const computeGroupShare = async (year) => {
            try {
                const payments = await loadData('payments', []);
                const loans = await loadData('loans', []);
                const members = await loadData('users', []);
                
                if (members.length === 0) return {};

                const yearPayments = payments.filter(p => getYear(p.date) === year);
                const monthlySums = {};
                const contributingMonths = {};

                // Calculate total payments per member per month and count contributing months
                yearPayments.forEach(p => {
                    const month = getMonth(p.date);
                    const key = `${year}-${month}-${p.member}`;
                    monthlySums[key] = (monthlySums[key] || 0) + (parseFloat(p.paidIn) || 0);
                });

                let totalFines = 0;

                // Initialize contributing months for each member
                members.forEach(member => {
                    contributingMonths[member.name] = 0;
                });

                // Calculate fines and contributing months
                members.forEach(member => {
                    for (let month = 1; month <= 12; month++) {
                        const key = `${year}-${month}-${member.name}`;
                        const val = monthlySums[key] || 0;
                        if (val < 300) {
                            totalFines += 50; // Fine for underpayment
                        } else {
                            contributingMonths[member.name] += 1; // Count month where contribution >= 300 KES
                        }
                    }
                });

                // Calculate total contributing months across all members
                const totalContributingMonths = Object.values(contributingMonths).reduce((sum, count) => sum + count, 0);

                const totalLoans = loans.filter(l => getYear(l.date) === year).reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const totalInterest = totalLoans * 0.1;

                const totalProfit = totalFines + totalInterest;

                const shares = {};
                members.forEach(member => {
                    if (totalContributingMonths > 0) {
                        const proportion = contributingMonths[member.name] / totalContributingMonths;
                        shares[member.name] = totalProfit * proportion;
                    } else {
                        shares[member.name] = 0;
                    }
                });

                return shares;
            } catch (e) {
                console.error("Error computing member shares:", e);
                const members = await loadData('users', []);
                return members.reduce((acc, member) => ({ ...acc, [member.name]: 0 }), {});
            }
        };

        // ErrorBoundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorMessage: '' };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, errorMessage: error.message };
            }
            componentDidCatch(error, info) {
                console.error('ErrorBoundary caught', error, info);
            }
            render() {
                if (this.state.hasError) {
                    return <div className="alert alert-danger">Something went wrong: {this.state.errorMessage}</div>;
                }
                return this.props.children;
            }
        }

        // DatabaseInitializer
        function DatabaseInitializer({ children }) {
            const [isInitialized, setIsInitialized] = useState(false);
            const [error, setError] = useState('');
            const [retryCount, setRetryCount] = useState(0);
            const maxRetries = 3;
            useEffect(() => {
                const init = async () => {
                    try {
                        const success = await initializeFirebase();
                        if (success) {
                            setIsInitialized(true);
                        } else {
                            throw new Error("Failed to initialize Firebase.");
                        }
                    } catch (e) {
                        if (retryCount < maxRetries) {
                            setTimeout(() => setRetryCount(retryCount + 1), 2000);
                        } else {
                            setError(`Initialization failed after ${maxRetries} attempts: ${e.message}`);
                        }
                    }
                };
                init();
            }, [retryCount]);
            if (error) {
                return (
                    <div className="init-error">
                        <h3>Application Initialization Error</h3>
                        <p>{error}</p>
                        <button className="btn btn-primary mt-3 me-2" onClick={() => { setRetryCount(0); setError(''); }}>
                            Retry
                        </button>
                        <button className="btn btn-secondary mt-3" onClick={() => window.location.reload()}>
                            Refresh
                        </button>
                    </div>
                );
            }
            if (!isInitialized) {
                return <div className="loading">Initializing... (Attempt {retryCount + 1}/{maxRetries})</div>;
            }
            return children;
        }

        // Login
        function Login({ onLogin }) {
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const hashed = sha256(password || '');
                    const user = users.find(u => u.name === name && u.password === hashed);
                    if (user) {
                        onLogin(user);
                    } else {
                        setError('Invalid credentials');
                        setTimeout(() => setError(''), 3000);
                    }
                } catch (e) {
                    setError('Error logging in: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div className="container mt-5">
                        <div className="row justify-content-center">
                            <div className="col-md-6 col-sm-8">
                                <div className="card">
                                    <div className="card-body">
                                        <h2 className="card-title text-center">Login</h2>
                                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                                        {loading && <div className="loading">Loading...</div>}
                                        <form onSubmit={handleSubmit}>
                                            <div className="mb-3">
                                                <label className="form-label">Name</label>
                                                <input type="text" className="form-control" value={name} onChange={e => setName(e.target.value)} required disabled={loading} />
                                            </div>
                                            <div className="mb-3">
                                                <label className="form-label">Password</label>
                                                <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} required disabled={loading} />
                                            </div>
                                            <button type="submit" className="btn btn-success w-100" disabled={loading}>Login</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // Dashboard
        function Dashboard({ user, onLogout }) {
            const [view, setView] = useState('home');
            const [year, setYear] = useState(new Date().getFullYear());
            const [alert, setAlert] = useState('');
            const showAlert = (msg) => {
                setAlert(msg);
                setTimeout(() => setAlert(''), 3000);
            };
            const renderView = () => {
                const viewProps = { year, setYear };
                switch (view) {
                    case 'addMember': return user.role === 'Admin' ? <AddMember onSuccess={() => showAlert('Member added')} /> : <AccessDenied />;
                    case 'batchAddMembers': return user.role === 'Admin' ? <BatchAddMembers onSuccess={() => showAlert('Members added')} /> : <AccessDenied />;
                    case 'viewMembers': return user.role === 'Admin' ? <ViewMembers onRemoveSuccess={() => showAlert('Member(s) removed')} onEditSuccess={() => showAlert('Member updated')} /> : <AccessDenied />;
                    case 'addPayment': return ['Admin', 'Secretary'].includes(user.role) ? <AddPayment onSuccess={() => showAlert('Payment added')} /> : <AccessDenied />;
                    case 'batchAddPayments': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddPayments onSuccess={() => showAlert('Payments added')} /> : <AccessDenied />;
                    case 'addLoan': return ['Admin', 'Secretary'].includes(user.role) ? <AddLoan onSuccess={() => showAlert('Loan added')} /> : <AccessDenied />;
                    case 'batchAddLoans': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddLoans onSuccess={() => showAlert('Loans added')} /> : <AccessDenied />;
                    case 'addExpenditure': return ['Admin', 'Secretary'].includes(user.role) ? <AddExpenditure onSuccess={() => showAlert('Expenditure added')} /> : <AccessDenied />;
                    case 'batchAddExpenditures': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddExpenditures onSuccess={() => showAlert('Expenditures added')} /> : <AccessDenied />;
                    case 'viewAll': return ['Admin', 'Secretary', 'Chairman', 'Treasurer', 'Member'].includes(user.role) ? <ViewAllData {...viewProps} /> : <AccessDenied />;
                    case 'viewPersonal': return true ? <ViewPersonal userId={user.name} {...viewProps} /> : <AccessDenied />;
                    case 'download': return user.role === 'Admin' ? <DownloadData year={year} /> : <AccessDenied />;
                    case 'monthlySummary': return ['Admin', 'Secretary', 'Chairman'].includes(user.role) ? <MonthlySummary {...viewProps} /> : <AccessDenied />;
                    case 'uploadData': return user.role === 'Admin' ? <UploadData onSuccess={() => showAlert('Data uploaded')} /> : <AccessDenied />;
                    case 'manageTransactions': return user.role === 'Admin' ? <ManageTransactions year={year} onDeleteSuccess={() => showAlert('Transactions deleted')} onEditSuccess={() => showAlert('Transaction updated')} /> : <AccessDenied />;
                    default: return <Home user={user} setView={setView} />;
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <nav className="navbar navbar-expand-lg">
                            <div className="container">
                                <a className="navbar-brand" href="#" onClick={(e) => { e.preventDefault(); setView('home'); }}>Makongeni Green Nairobi Welfare</a>
                                <div className="navbar-nav ms-auto">
                                    <span className="nav-link me-3">Welcome, {user.name}</span>
                                    <span className="nav-link" style={{cursor: 'pointer'}} onClick={onLogout}>Logout</span>
                                </div>
                            </div>
                        </nav>
                        <div className="container mt-4">
                            {alert && <div className="alert alert-success alert-dismissible">{alert}</div>}
                            {renderView()}
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // Home
        function Home({ user, setView }) {
            return (
                <div>
                    <h1 className="mb-4 text-center">Welcome, {user.name} ({user.role})</h1>
                    <div className="row">
                        {user.role === 'Admin' && (
                            <>
                                <h4 className="mb-3">Member Management</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addMember')}><div className="card-body text-center"><i className="bi bi-person-plus dashboard-icon fs-1"></i><h5 className="card-title">Add Member</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddMembers')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Members</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('viewMembers')}><div className="card-body text-center"><i className="bi bi-person-lines-fill dashboard-icon fs-1"></i><h5 className="card-title">View Members</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Financial Operations</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addPayment')}><div className="card-body text-center"><i className="bi bi-currency-exchange dashboard-icon fs-1"></i><h5 className="card-title">Add Payment</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddPayments')}><div className="card-body text-center"><i className="bi bi-receipt dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Payments</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addLoan')}><div className="card-body text-center"><i className="bi bi-bank dashboard-icon fs-1"></i><h5 className="card-title">Add Loan</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddLoans')}><div className="card-body text-center"><i className="bi bi-credit-card dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Loans</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addExpenditure')}><div className="card-body text-center"><i className="bi bi-wallet dashboard-icon fs-1"></i><h5 className="card-title">Add Expenditure</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddExpenditures')}><div className="card-body text-center"><i className="bi bi-receipt-cutoff dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Expenditures</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('manageTransactions')}><div className="card-body text-center"><i className="bi bi-trash dashboard-icon fs-1"></i><h5 className="card-title">Manage Transactions</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Data Views</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('viewPersonal')}><div className="card-body text-center"><i className="bi bi-person dashboard-icon fs-1"></i><h5 className="card-title">Personal Data</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('viewAll')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Group Data</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Reports</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('monthlySummary')}><div className="card-body text-center"><i className="bi bi-calendar dashboard-icon fs-1"></i><h5 className="card-title">Monthly Summary</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('uploadData')}><div className="card-body text-center"><i className="bi bi-upload dashboard-icon fs-1"></i><h5 className="card-title">Upload Data</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('download')}><div className="card-body text-center"><i className="bi bi-download dashboard-icon fs-1"></i><h5 className="card-title">Download Data</h5></div></div></div>
                            </>
                        )}
                        {user.role === 'Secretary' && (
                            <>
                                <h4 className="mb-3">Financial Operations</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addPayment')}><div className="card-body text-center"><i className="bi bi-currency-exchange dashboard-icon fs-1"></i><h5 className="card-title">Add Payment</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddPayments')}><div className="card-body text-center"><i className="bi bi-receipt dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Payments</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addLoan')}><div className="card-body text-center"><i className="bi bi-bank dashboard-icon fs-1"></i><h5 className="card-title">Add Loan</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddLoans')}><div className="card-body text-center"><i className="bi bi-credit-card dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Loans</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('addExpenditure')}><div className="card-body text-center"><i className="bi bi-wallet dashboard-icon fs-1"></i><h5 className="card-title">Add Expenditure</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('batchAddExpenditures')}><div className="card-body text-center"><i className="bi bi-receipt-cutoff dashboard-icon fs-1"></i><h5 className="card-title">Batch Add Expenditures</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Data Views</h4>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('viewPersonal')}><div className="card-body text-center"><i className="bi bi-person dashboard-icon fs-1"></i><h5 className="card-title">Personal Data</h5></div></div></div>
                                <div className="col-md-4 mb-3"><div className="card dashboard-card" onClick={() => setView('viewAll')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Group Data</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Reports</h4>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('monthlySummary')}><div className="card-body text-center"><i className="bi bi-calendar dashboard-icon fs-1"></i><h5 className="card-title">Monthly Summary</h5></div></div></div>
                            </>
                        )}
                        {user.role === 'Chairman' && (
                            <>
                                <h4 className="mb-3">Data Views</h4>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewPersonal')}><div className="card-body text-center"><i className="bi bi-person dashboard-icon fs-1"></i><h5 className="card-title">Personal Data</h5></div></div></div>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewAll')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Group Data</h5></div></div></div>
                                <h4 className="mb-3 mt-4">Reports</h4>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('monthlySummary')}><div className="card-body text-center"><i className="bi bi-calendar dashboard-icon fs-1"></i><h5 className="card-title">Monthly Summary</h5></div></div></div>
                            </>
                        )}
                        {user.role === 'Treasurer' && (
                            <>
                                <h4 className="mb-3">Data Views</h4>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewPersonal')}><div className="card-body text-center"><i className="bi bi-person dashboard-icon fs-1"></i><h5 className="card-title">Personal Data</h5></div></div></div>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewAll')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Group Data</h5></div></div></div>
                            </>
                        )}
                        {user.role === 'Member' && (
                            <>
                                <h4 className="mb-3">Data Views</h4>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewPersonal')}><div className="card-body text-center"><i className="bi bi-person dashboard-icon fs-1"></i><h5 className="card-title">Personal Data</h5></div></div></div>
                                <div className="col-md-6 mb-3"><div className="card dashboard-card" onClick={() => setView('viewAll')}><div className="card-body text-center"><i className="bi bi-people dashboard-icon fs-1"></i><h5 className="card-title">Group Data</h5></div></div></div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // AccessDenied
        function AccessDenied() {
            return <div className="alert alert-danger">Access Denied</div>;
        }

        // AddMember
        function AddMember({ onSuccess }) {
            const [name, setName] = useState('');
            const [role, setRole] = useState('Member');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async () => {
                if (!name || !password) {
                    setError('Please provide both name and password');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (!confirm('Confirm adding this member?')) return;
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    if (users.find(u => u.name === name)) {
                        setError('Name already exists');
                        setTimeout(() => setError(''), 3000);
                        return;
                    }
                    await addData('users', { name, role, password: sha256(password) });
                    setName(''); setPassword(''); setRole('Member');
                    onSuccess();
                } catch (e) {
                    setError('Error adding member: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Add New Member</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <label className="form-label">Name</label>
                                    <input type="text" className="form-control" value={name} onChange={e => setName(e.target.value)} required disabled={loading} />
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Role</label>
                                    <select className="form-select" value={role} onChange={e => setRole(e.target.value)} disabled={loading}>
                                        <option value="Admin">Admin</option>
                                        <option value="Secretary">Secretary</option>
                                        <option value="Chairman">Chairman</option>
                                        <option value="Treasurer">Treasurer</option>
                                        <option value="Member">Member</option>
                                    </select>
                                </div>
                                <div className="mb-3">
                                    <label className="form-label">Password</label>
                                    <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} required disabled={loading} />
                                </div>
                                <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Member</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // BatchAddMembers
        function BatchAddMembers({ onSuccess }) {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async () => {
                if (!input.trim()) {
                    setError('Please enter member data');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                const lines = input.trim().split('\n').filter(line => line.trim());
                if (!confirm(`Confirm adding ${lines.length} members?`)) return;
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const newMembers = [];
                    const batch = firebase.writeBatch(db);
                    for (const line of lines) {
                        const [name, role = 'Member', password] = line.split(',').map(s => s.trim());
                        if (!name || !password) throw new Error(`Invalid format in line: ${line}`);
                        if (users.find(u => u.name === name) || newMembers.find(m => m.name === name)) throw new Error(`Duplicate name: ${name}`);
                        if (!['Admin', 'Secretary', 'Chairman', 'Treasurer', 'Member'].includes(role)) throw new Error(`Invalid role for ${name}: ${role}`);
                        const docRef = firebase.doc(firebase.collection(db, 'users'));
                        batch.set(docRef, { name, role, password: sha256(password) });
                        newMembers.push({ name });
                    }
                    await batch.commit();
                    setInput('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding members: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Batch Add Members</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <label className="form-label">Members Data (one per line: name,role,password)</label>
                                    <textarea
                                        className="form-control"
                                        rows="10"
                                        value={input}
                                        onChange={e => setInput(e.target.value)}
                                        disabled={loading}
                                        placeholder="Example:\nJohn,Member,johnpass\nJane,Secretary,janepass"
                                    />
                                </div>
                                <p className="text-muted">Role is optional, defaults to 'Member'. Valid roles: Admin, Secretary, Chairman, Treasurer, Member.</p>
                                <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Members</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // BatchAddPayments
        function BatchAddPayments({ onSuccess }) {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async () => {
                if (!input.trim()) {
                    setError('Please enter payment data');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                const lines = input.trim().split('\n').filter(line => line.trim());
                if (!confirm(`Confirm adding ${lines.length} payments?`)) return;
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const batch = firebase.writeBatch(db);
                    for (const line of lines) {
                        const parts = line.split(',').map(s => s.trim());
                        let member, date, paidIn;
                        if (parts.length === 3) {
                            [member, date, paidIn] = parts;
                        } else if (parts.length === 2) {
                            [member, paidIn] = parts;
                            date = new Date().toISOString().split('T')[0];
                        } else {
                            throw new Error(`Invalid format in line: ${line}`);
                        }
                        if (!member || !paidIn || isNaN(parseFloat(paidIn))) throw new Error(`Invalid data in line: ${line}`);
                        if (!users.find(u => u.name === member)) throw new Error(`Member not found: ${member}`);
                        const docRef = firebase.doc(firebase.collection(db, 'payments'));
                        batch.set(docRef, { member, date, paidIn: parseFloat(paidIn) });
                    }
                    await batch.commit();
                    setInput('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding payments: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Batch Add Payments</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <label className="form-label">Payments Data (one per line: member,date,paidIn or member,paidIn)</label>
                                    <textarea
                                        className="form-control"
                                        rows="10"
                                        value={input}
                                        onChange={e => setInput(e.target.value)}
                                        disabled={loading}
                                        placeholder="Example:\nJohn,2025-09-20,300\nJane,500"
                                    />
                                </div>
                                <p className="text-muted">Date format: YYYY-MM-DD. If omitted, uses today.</p>
                                <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Payments</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // BatchAddLoans
        function BatchAddLoans({ onSuccess }) {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async () => {
                if (!input.trim()) {
                    setError('Please enter loan data');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                const lines = input.trim().split('\n').filter(line => line.trim());
                if (!confirm(`Confirm adding ${lines.length} loans?`)) return;
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const batch = firebase.writeBatch(db);
                    for (const line of lines) {
                        const parts = line.split(',').map(s => s.trim());
                        let member, date, amount;
                        if (parts.length === 3) {
                            [member, date, amount] = parts;
                        } else if (parts.length === 2) {
                            [member, amount] = parts;
                            date = new Date().toISOString().split('T')[0];
                        } else {
                            throw new Error(`Invalid format in line: ${line}`);
                        }
                        if (!member || !amount || isNaN(parseFloat(amount))) throw new Error(`Invalid data in line: ${line}`);
                        if (!users.find(u => u.name === member)) throw new Error(`Member not found: ${member}`);
                        const docRef = firebase.doc(firebase.collection(db, 'loans'));
                        batch.set(docRef, { member, date, amount: parseFloat(amount) });
                    }
                    await batch.commit();
                    setInput('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding loans: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Batch Add Loans</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <label className="form-label">Loans Data (one per line: member,date,amount or member,amount)</label>
                                    <textarea
                                        className="form-control"
                                        rows="10"
                                        value={input}
                                        onChange={e => setInput(e.target.value)}
                                        disabled={loading}
                                        placeholder="Example:\nJohn,2025-09-20,1000\nJane,500"
                                    />
                                </div>
                                <p className="text-muted">Date format: YYYY-MM-DD. If omitted, uses today.</p>
                                <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Loans</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // BatchAddExpenditures
        function BatchAddExpenditures({ onSuccess }) {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleSubmit = async () => {
                if (!input.trim()) {
                    setError('Please enter expenditure data');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                const lines = input.trim().split('\n').filter(line => line.trim());
                if (!confirm(`Confirm adding ${lines.length} expenditures?`)) return;
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const batch = firebase.writeBatch(db);
                    for (const line of lines) {
                        const parts = line.split(',').map(s => s.trim());
                        let member, date, amount;
                        if (parts.length === 3) {
                            [member, date, amount] = parts;
                        } else if (parts.length === 2) {
                            [member, amount] = parts;
                            date = new Date().toISOString().split('T')[0];
                        } else {
                            throw new Error(`Invalid format in line: ${line}`);
                        }
                        if (!member || !amount || isNaN(parseFloat(amount))) throw new Error(`Invalid data in line: ${line}`);
                        if (!users.find(u => u.name === member)) throw new Error(`Member not found: ${member}`);
                        const docRef = firebase.doc(firebase.collection(db, 'expenditures'));
                        batch.set(docRef, { member, date, amount: parseFloat(amount) });
                    }
                    await batch.commit();
                    setInput('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding expenditures: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Batch Add Expenditures</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="mb-3">
                                    <label className="form-label">Expenditures Data (one per line: member,date,amount or member,amount)</label>
                                    <textarea
                                        className="form-control"
                                        rows="10"
                                        value={input}
                                        onChange={e => setInput(e.target.value)}
                                        disabled={loading}
                                        placeholder="Example:\nJohn,2025-09-20,1500\nJane,800"
                                    />
                                </div>
                                <p className="text-muted">Date format: YYYY-MM-DD. If omitted, uses today.</p>
                                <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Expenditures</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // AddPayment
        function AddPayment({ onSuccess }) {
            const [member, setMember] = useState('');
            const [paidIn, setPaidIn] = useState('');
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            useEffect(() => {
                loadData('users', []).then(data => {
                    setUsers(data.sort((a, b) => a.name.localeCompare(b.name)));
                    setLoading(false);
                }).catch(e => {
                    setError('Error loading users: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, []);
            const handleSubmit = async () => {
                if (!member || !paidIn) {
                    setError('Please fill all fields');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (!confirm('Confirm adding payment?')) return;
                setLoading(true);
                setError('');
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await addData('payments', { member, date: today, paidIn: parseFloat(paidIn) });
                    setPaidIn(''); setMember('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding payment: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Add Payment</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        {!loading && (
                            <div className="row justify-content-center">
                                <div className="col-md-6">
                                    <div className="mb-3">
                                        <label className="form-label">Member</label>
                                        <select className="form-select" value={member} onChange={e => setMember(e.target.value)} required disabled={loading}>
                                            <option value="">Select Member</option>
                                            {users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Paid In (KES)</label>
                                        <input type="number" step="0.01" className="form-control" value={paidIn} onChange={e => setPaidIn(e.target.value)} required disabled={loading} />
                                    </div>
                                    <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Payment</button>
                                    <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                                </div>
                            </div>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        // AddLoan
        function AddLoan({ onSuccess }) {
            const [member, setMember] = useState('');
            const [amount, setAmount] = useState('');
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            useEffect(() => {
                loadData('users', []).then(data => {
                    setUsers(data.sort((a, b) => a.name.localeCompare(b.name)));
                    setLoading(false);
                }).catch(e => {
                    setError('Error loading users: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, []);
            const handleSubmit = async () => {
                if (!member || !amount) {
                    setError('Please fill all fields');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (!confirm('Confirm adding loan?')) return;
                setLoading(true);
                setError('');
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await addData('loans', { member, date: today, amount: parseFloat(amount) });
                    setAmount(''); setMember('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding loan: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Add Loan</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        {!loading && (
                            <div className="row justify-content-center">
                                <div className="col-md-6">
                                    <div className="mb-3">
                                        <label className="form-label">Member</label>
                                        <select className="form-select" value={member} onChange={e => setMember(e.target.value)} required disabled={loading}>
                                            <option value="">Select Member</option>
                                            {users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Loan Amount (KES)</label>
                                        <input type="number" step="0.01" className="form-control" value={amount} onChange={e => setAmount(e.target.value)} required disabled={loading} />
                                    </div>
                                    <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Loan</button>
                                    <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                                </div>
                            </div>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        // AddExpenditure
        function AddExpenditure({ onSuccess }) {
            const [member, setMember] = useState('');
            const [amount, setAmount] = useState('');
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            useEffect(() => {
                loadData('users', []).then(data => {
                    setUsers(data.sort((a, b) => a.name.localeCompare(b.name)));
                    setLoading(false);
                }).catch(e => {
                    setError('Error loading users: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, []);
            const handleSubmit = async () => {
                if (!member || !amount) {
                    setError('Please fill all fields');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (!confirm('Confirm adding expenditure?')) return;
                setLoading(true);
                setError('');
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await addData('expenditures', { member, date: today, amount: parseFloat(amount) });
                    setAmount(''); setMember('');
                    onSuccess();
                } catch (e) {
                    setError('Error adding expenditure: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Add Expenditure</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        {!loading && (
                            <div className="row justify-content-center">
                                <div className="col-md-6">
                                    <div className="mb-3">
                                        <label className="form-label">Member</label>
                                        <select className="form-select" value={member} onChange={e => setMember(e.target.value)} required disabled={loading}>
                                            <option value="">Select Member</option>
                                            {users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Amount (KES)</label>
                                        <input type="number" step="0.01" className="form-control" value={amount} onChange={e => setAmount(e.target.value)} required disabled={loading} />
                                    </div>
                                    <button className="btn btn-success" onClick={handleSubmit} disabled={loading}>Add Expenditure</button>
                                    <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                                </div>
                            </div>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        // ViewMembers
        function ViewMembers({ onRemoveSuccess, onEditSuccess }) {
            const [users, setUsers] = useState([]);
            const [selectedUsers, setSelectedUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('name');
            const [sortDirection, setSortDirection] = useState('asc');
            const [editingUser, setEditingUser] = useState(null);
            useEffect(() => {
                loadData('users', []).then(data => {
                    setUsers(data.sort((a, b) => a.name.localeCompare(b.name)));
                    setLoading(false);
                }).catch(e => {
                    setError('Error loading members: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, []);
            const handleSelect = (name) => {
                if (name === 'admin') return;
                setSelectedUsers(prev =>
                    prev.includes(name) ? prev.filter(u => u !== name) : [...prev, name]
                );
            };
            const handleRemoveSingle = async (name) => {
                if (name === 'admin') {
                    alert('Cannot remove default admin');
                    return;
                }
                if (!confirm(`Remove ${name}? This will delete their payments and loans.`)) return;
                setLoading(true);
                setError('');
                try {
                    await Promise.all([
                        deleteData('users', 'name', name),
                        deleteData('payments', 'member', name),
                        deleteData('loans', 'member', name),
                        deleteData('expenditures', 'member', name)
                    ]);
                    setUsers(users.filter(u => u.name !== name));
                    setSelectedUsers(selectedUsers.filter(u => u !== name));
                    onRemoveSuccess();
                } catch (e) {
                    setError('Error removing member: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            const handleRemoveMultiple = async () => {
                if (selectedUsers.length === 0) {
                    setError('Select at least one member');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (selectedUsers.includes('admin')) {
                    alert('Cannot remove default admin');
                    return;
                }
                if (!confirm(`Remove ${selectedUsers.length} member(s)? This will delete their payments and loans.`)) return;
                setLoading(true);
                setError('');
                try {
                    await Promise.all(selectedUsers.map(name =>
                        Promise.all([
                            deleteData('users', 'name', name),
                            deleteData('payments', 'member', name),
                            deleteData('loans', 'member', name),
                            deleteData('expenditures', 'member', name)
                        ])
                    ));
                    setUsers(users.filter(u => !selectedUsers.includes(u.name)));
                    setSelectedUsers([]);
                    onRemoveSuccess();
                } catch (e) {
                    setError('Error removing members: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            const handleEdit = (user) => {
                if (user.name === 'admin') {
                    alert('Cannot edit default admin');
                    return;
                }
                setEditingUser({ ...user, newPassword: '' });
            };
            const handleSaveEdit = async () => {
                if (!editingUser.role) {
                    setError('Role is required');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                setLoading(true);
                try {
                    const updates = { role: editingUser.role };
                    if (editingUser.newPassword) {
                        updates.password = sha256(editingUser.newPassword);
                    }
                    await updateData('users', editingUser.id, updates);
                    setUsers(users.map(u => u.id === editingUser.id ? { ...u, ...updates } : u));
                    setEditingUser(null);
                    onEditSuccess();
                } catch (e) {
                    setError('Error updating member: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            const filteredUsers = users.filter(u => u.name.toLowerCase().includes(searchTerm.toLowerCase()) || u.role.toLowerCase().includes(searchTerm.toLowerCase()));
            const sortedUsers = filteredUsers.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Members List</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        {!loading && (
                            <div>
                                <div className="mb-3">
                                    <input type="text" className="form-control d-inline-block w-50 me-2" placeholder="Search by name or role" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    <button className="btn btn-danger" onClick={handleRemoveMultiple} disabled={selectedUsers.length === 0 || loading}>
                                        Remove Selected ({selectedUsers.length})
                                    </button>
                                    <button className="btn btn-secondary ms-2" onClick={() => setSelectedUsers([])} disabled={selectedUsers.length === 0 || loading}>
                                        Clear Selection
                                    </button>
                                </div>
                                <div className="table-responsive">
                                    <table className="table table-striped">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" checked={selectedUsers.length === sortedUsers.filter(u => u.name !== 'admin').length} onChange={() => {
                                                    if (selectedUsers.length === sortedUsers.filter(u => u.name !== 'admin').length) {
                                                        setSelectedUsers([]);
                                                    } else {
                                                        setSelectedUsers(sortedUsers.filter(u => u.name !== 'admin').map(u => u.name));
                                                    }
                                                }} disabled={loading} /></th>
                                                <th className={`sortable ${sortColumn === 'name' ? sortDirection : ''}`} onClick={() => handleSort('name')}>Name</th>
                                                <th className={`sortable ${sortColumn === 'role' ? sortDirection : ''}`} onClick={() => handleSort('role')}>Role</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sortedUsers.map(u => (
                                                <tr key={u.name}>
                                                    <td><input type="checkbox" checked={selectedUsers.includes(u.name)} onChange={() => handleSelect(u.name)} disabled={u.name === 'admin' || loading} /></td>
                                                    <td>{u.name}</td>
                                                    <td>{u.role}</td>
                                                    <td>
                                                        <button className="btn btn-primary btn-sm me-2" onClick={() => handleEdit(u)} disabled={u.name === 'admin' || loading}>Edit</button>
                                                        <button className="btn btn-danger btn-sm" onClick={() => handleRemoveSingle(u.name)} disabled={u.name === 'admin' || loading}>Remove</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <button className="btn btn-secondary mt-3" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                            </div>
                        )}
                        {editingUser && (
                            <div className="modal fade show d-block" tabIndex="-1" role="dialog">
                                <div className="modal-dialog" role="document">
                                    <div className="modal-content">
                                        <div className="modal-header">
                                            <h5 className="modal-title">Edit Member: {editingUser.name}</h5>
                                            <button type="button" className="btn-close" onClick={() => setEditingUser(null)}></button>
                                        </div>
                                        <div className="modal-body">
                                            <div className="mb-3">
                                                <label className="form-label">Role</label>
                                                <select className="form-select" value={editingUser.role} onChange={e => setEditingUser({ ...editingUser, role: e.target.value })}>
                                                    <option value="Admin">Admin</option>
                                                    <option value="Secretary">Secretary</option>
                                                    <option value="Chairman">Chairman</option>
                                                    <option value="Treasurer">Treasurer</option>
                                                    <option value="Member">Member</option>
                                                </select>
                                            </div>
                                            <div className="mb-3">
                                                <label className="form-label">New Password (leave blank to keep current)</label>
                                                <input type="password" className="form-control" value={editingUser.newPassword} onChange={e => setEditingUser({ ...editingUser, newPassword: e.target.value })} />
                                            </div>
                                        </div>
                                        <div className="modal-footer">
                                            <button type="button" className="btn btn-secondary" onClick={() => setEditingUser(null)}>Close</button>
                                            <button type="button" className="btn btn-primary" onClick={handleSaveEdit}>Save changes</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        // ViewPersonal
        function ViewPersonal({ userId, year, setYear }) {
            const [allPayments, setAllPayments] = useState([]);
            const [allLoans, setAllLoans] = useState([]);
            const [allExpenditures, setAllExpenditures] = useState([]);
            const [share, setShare] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('month');
            const [sortDirection, setSortDirection] = useState('asc');
            useEffect(() => {
                setLoading(true);
                setError('');
                Promise.all([
                    loadData('payments', []).then(data => setAllPayments(data.filter(p => getYear(p.date) === year))),
                    loadData('loans', []).then(data => setAllLoans(data.filter(l => getYear(l.date) === year))),
                    loadData('expenditures', []).then(data => setAllExpenditures(data.filter(e => getYear(e.date) === year))),
                    computeGroupShare(year).then(data => setShare(data))
                ]).then(() => setLoading(false)).catch(e => {
                    setError('Error loading data: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, [year]);
            if (loading) return <div className="loading">Loading...</div>;
            if (error) return <div className="alert alert-danger">{error}</div>;
            const userPayments = allPayments.filter(p => p.member === userId);
            const userLoans = allLoans.filter(l => l.member === userId);
            const userExpenditures = allExpenditures.filter(e => e.member === userId);
            const monthlyData = {};
            userPayments.forEach(p => {
                const m = getMonth(p.date);
                monthlyData[m] = monthlyData[m] || { paid: 0, dates: [] };
                monthlyData[m].paid += (parseFloat(p.paidIn) || 0);
                monthlyData[m].dates.push(p.date);
            });
            const monthlyLoans = {};
            userLoans.forEach(l => {
                const m = getMonth(l.date);
                monthlyLoans[m] = (monthlyLoans[m] || 0) + (parseFloat(l.amount) || 0);
            });
            const monthlyExpenditures = {};
            userExpenditures.forEach(e => {
                const m = getMonth(e.date);
                monthlyExpenditures[m] = (monthlyExpenditures[m] || 0) + (parseFloat(e.amount) || 0);
            });
            const totalPaid = Object.values(monthlyData).reduce((sum, m) => sum + m.paid, 0);
            const totalFines = Object.values(monthlyData).reduce((sum, m) => sum + (m.paid < 300 ? 50 : 0), 0);
            const totalLoan = userLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const totalLoanInterest = totalLoan * 0.1;
            const totalExpenditures = userExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const memberShare = share[userId] || 0;
            const net = totalPaid - totalFines - totalExpenditures + memberShare - totalLoan - totalLoanInterest;
            let months = MONTH_NAMES.map((name, i) => {
                const mIndex = i + 1;
                const data = monthlyData[mIndex] || { paid: 0, dates: [] };
                return { month: name, paid: data.paid, fine: data.paid < 300 ? 50 : 0, dates: data.dates.join(', '), loan: monthlyLoans[mIndex] || 0, exp: monthlyExpenditures[mIndex] || 0 };
            });
            months = months.filter(m => m.month.toLowerCase().includes(searchTerm.toLowerCase()));
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            months.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (sortColumn === 'month') {
                    valA = MONTH_NAMES.indexOf(a.month);
                    valB = MONTH_NAMES.indexOf(b.month);
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            return (
                <ErrorBoundary>
                    <div>
                        <div className="mb-3">
                            <label className="form-label">Year</label>
                            <select className="form-select w-auto d-inline-block" value={year} onChange={e => setYear(parseInt(e.target.value, 10))}>
                                <option value={2024}>2024</option>
                                <option value={2025}>2025</option>
                                <option value={2026}>2026</option>
                            </select>
                        </div>
                        <h2>Personal Financial Data for {year}</h2>
                        <div className="row">
                            <div className="col-md-8">
                                <h4>Monthly Breakdown</h4>
                                <input type="text" className="form-control mb-3" placeholder="Search by month" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div className="table-responsive">
                                    <table className="table table-striped">
                                        <thead>
                                            <tr>
                                                <th className={`sortable ${sortColumn === 'month' ? sortDirection : ''}`} onClick={() => handleSort('month')}>Month</th>
                                                <th className={`sortable ${sortColumn === 'paid' ? sortDirection : ''}`} onClick={() => handleSort('paid')}>Total Paid (KES)</th>
                                                <th className={`sortable ${sortColumn === 'fine' ? sortDirection : ''}`} onClick={() => handleSort('fine')}>Fine (KES)</th>
                                                <th className={`sortable ${sortColumn === 'loan' ? sortDirection : ''}`} onClick={() => handleSort('loan')}>Total Loans (KES)</th>
                                                <th className={`sortable ${sortColumn === 'exp' ? sortDirection : ''}`} onClick={() => handleSort('exp')}>Total Expenditures (KES)</th>
                                                <th>Payment Dates</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {months.map((m, i) => (
                                                <tr key={i}>
                                                    <td>{m.month}</td>
                                                    <td>{m.paid.toFixed(2)}</td>
                                                    <td>{m.fine}</td>
                                                    <td>{m.loan.toFixed(2)}</td>
                                                    <td>{m.exp.toFixed(2)}</td>
                                                    <td>{m.dates}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="col-md-4">
                                <div className="card">
                                    <div className="card-body">
                                        <h5 className="card-title">Yearly Summary</h5>
                                        <p><strong>Total Paid:</strong> {totalPaid.toFixed(2)} KES</p>
                                        <p><strong>Total Fines (deducted):</strong> {totalFines.toFixed(2)} KES</p>
                                        <p><strong>Total Expenditures (deducted):</strong> {totalExpenditures.toFixed(2)} KES</p>
                                        <p><strong>Total Loans:</strong> {totalLoan.toFixed(2)} KES</p>
                                        <p><strong>Total Loan Interest (deducted):</strong> {totalLoanInterest.toFixed(2)} KES</p>
                                        <p><strong>Member Share:</strong> {memberShare.toFixed(2)} KES</p>
                                        <p><span className={net >= 0 ? 'positive' : 'negative'}><strong>Net Amount:</strong> {net.toFixed(2)} KES</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button className="btn btn-secondary mt-2" onClick={() => window.location.reload()}>Back</button>
                    </div>
                </ErrorBoundary>
            );
        }

        // ViewAllData
        function ViewAllData({ year, setYear }) {
            const [allPayments, setAllPayments] = useState([]);
            const [allLoans, setAllLoans] = useState([]);
            const [allExpenditures, setAllExpenditures] = useState([]);
            const [users, setUsers] = useState([]);
            const [share, setShare] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('name');
            const [sortDirection, setSortDirection] = useState('asc');

            useEffect(() => {
                setLoading(true);
                setError('');
                Promise.all([
                    loadData('payments', []).then(data => setAllPayments(data.filter(p => getYear(p.date) === year))),
                    loadData('loans', []).then(data => setAllLoans(data.filter(l => getYear(l.date) === year))),
                    loadData('expenditures', []).then(data => setAllExpenditures(data.filter(e => getYear(e.date) === year))),
                    loadData('users', []).then(data => setUsers(data.sort((a, b) => a.name.localeCompare(b.name)))),
                    computeGroupShare(year).then(data => setShare(data))
                ]).then(() => setLoading(false)).catch(e => {
                    setError('Error loading data: ' + e.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, [year]);

            if (loading) return <div className="loading">Loading...</div>;
            if (error) return <div className="alert alert-danger">{error}</div>;

            const totalFines = users.reduce((sum, user) => {
                const userPayments = allPayments.filter(p => p.member === user.name);
                const monthlySums = {};
                userPayments.forEach(p => {
                    const m = getMonth(p.date);
                    monthlySums[m] = (monthlySums[m] || 0) + (parseFloat(p.paidIn) || 0);
                });
                return sum + Object.values(monthlySums).reduce((s, val) => s + (val < 300 ? 50 : 0), 0);
            }, 0);

            const totalExpenditures = allExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const totalLoans = allLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const totalLoanInterest = totalLoans * 0.1;
            const totalProfit = totalFines + totalLoanInterest;

            let memberData = users.map(user => {
                const userPayments = allPayments.filter(p => p.member === user.name);
                const totalPaid = userPayments.reduce((sum, p) => sum + (parseFloat(p.paidIn) || 0), 0);
                const monthlySums = {};
                userPayments.forEach(p => {
                    const m = getMonth(p.date);
                    monthlySums[m] = (monthlySums[m] || 0) + (parseFloat(p.paidIn) || 0);
                });
                const fines = Object.values(monthlySums).reduce((sum, val) => sum + (val < 300 ? 50 : 0), 0);
                const userLoans = allLoans.filter(l => l.member === user.name);
                const totalLoan = userLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const totalLoanInterest = totalLoan * 0.1;
                const userExpenditures = allExpenditures.filter(e => e.member === user.name);
                const totalExp = userExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const memberShare = share[user.name] || 0;
                const net = totalPaid - fines - totalExp + memberShare - totalLoan - totalLoanInterest;
                return { name: user.name, totalPaid, fines, totalExp, totalLoan, totalLoanInterest, memberShare, net };
            });

            memberData = memberData.filter(m => m.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };

            memberData.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (sortColumn === 'name') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return (
                <ErrorBoundary>
                    <div>
                        <div className="mb-3">
                            <label className="form-label">Year</label>
                            <select className="form-select w-auto d-inline-block" value={year} onChange={e => setYear(parseInt(e.target.value, 10))}>
                                <option value={2024}>2024</option>
                                <option value={2025}>2025</option>
                                <option value={2026}>2026</option>
                            </select>
                        </div>
                        <h2>Group Financial Data for {year}</h2>
                        <div className="row">
                            <div className="col-md-8">
                                <h4>Member Breakdown</h4>
                                <input type="text" className="form-control mb-3" placeholder="Search by name" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div className="table-responsive">
                                    <table className="table table-striped">
                                        <thead>
                                            <tr>
                                                <th className={`sortable ${sortColumn === 'name' ? sortDirection : ''}`} onClick={() => handleSort('name')}>Name</th>
                                                <th className={`sortable ${sortColumn === 'totalPaid' ? sortDirection : ''}`} onClick={() => handleSort('totalPaid')}>Total Paid (KES)</th>
                                                <th className={`sortable ${sortColumn === 'fines' ? sortDirection : ''}`} onClick={() => handleSort('fines')}>Fines (KES)</th>
                                                <th className={`sortable ${sortColumn === 'totalExp' ? sortDirection : ''}`} onClick={() => handleSort('totalExp')}>Total Expenditures (KES)</th>
                                                <th className={`sortable ${sortColumn === 'totalLoan' ? sortDirection : ''}`} onClick={() => handleSort('totalLoan')}>Total Loans (KES)</th>
                                                <th className={`sortable ${sortColumn === 'totalLoanInterest' ? sortDirection : ''}`} onClick={() => handleSort('totalLoanInterest')}>Loan Interest (KES)</th>
                                                <th className={`sortable ${sortColumn === 'memberShare' ? sortDirection : ''}`} onClick={() => handleSort('memberShare')}>Member Share (KES)</th>
                                                <th className={`sortable ${sortColumn === 'net' ? sortDirection : ''}`} onClick={() => handleSort('net')}>Net Amount (KES)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {memberData.map((m, i) => (
                                                <tr key={i}>
                                                    <td>{m.name}</td>
                                                    <td>{m.totalPaid.toFixed(2)}</td>
                                                    <td>{m.fines.toFixed(2)}</td>
                                                    <td>{m.totalExp.toFixed(2)}</td>
                                                    <td>{m.totalLoan.toFixed(2)}</td>
                                                    <td>{m.totalLoanInterest.toFixed(2)}</td>
                                                    <td>{m.memberShare.toFixed(2)}</td>
                                                    <td className={m.net >= 0 ? 'positive' : 'negative'}>{m.net.toFixed(2)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="col-md-4">
                                <div className="card">
                                    <div className="card-body">
                                        <h5 className="card-title">Group Summary</h5>
                                        <p><strong>Total Fines:</strong> {totalFines.toFixed(2)} KES</p>
                                        <p><strong>Total Expenditures:</strong> {totalExpenditures.toFixed(2)} KES</p>
                                        <p><strong>Total Loans:</strong> {totalLoans.toFixed(2)} KES</p>
                                        <p><strong>Total Loan Interest:</strong> {totalLoanInterest.toFixed(2)} KES</p>
                                        <p><strong>Total Profit:</strong> {totalProfit.toFixed(2)} KES</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button className="btn btn-secondary mt-2" onClick={() => window.location.reload()}>Back</button>
                    </div>
                </ErrorBoundary>
            );
        }

        // MonthlySummary
        function MonthlySummary({ year, setYear }) {
            const [data, setData] = useState({ payments: [], loans: [], exp: [] });
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('month');
            const [sortDirection, setSortDirection] = useState('asc');
            useEffect(() => {
                setLoading(true);
                Promise.all([
                    loadData('payments', []).then(p => setData(prev => ({ ...prev, payments: p.filter(pp => getYear(pp.date) === year) }))),
                    loadData('loans', []).then(l => setData(prev => ({ ...prev, loans: l.filter(ll => getYear(ll.date) === year) }))),
                    loadData('expenditures', []).then(e => setData(prev => ({ ...prev, exp: e.filter(ee => getYear(ee.date) === year) })))
                ]).then(() => setLoading(false)).catch(() => setLoading(false));
            }, [year]);
            if (loading) return <div className="loading">Loading...</div>;
            let summary = MONTH_NAMES.map((name, i) => {
                const m = i + 1;
                const paid = data.payments.filter(p => getMonth(p.date) === m).reduce((s, p) => s + parseFloat(p.paidIn || 0), 0);
                const loaned = data.loans.filter(l => getMonth(l.date) === m).reduce((s, l) => s + parseFloat(l.amount || 0), 0);
                const ex = data.exp.filter(e => getMonth(e.date) === m).reduce((s, e) => s + parseFloat(e.amount || 0), 0);
                const profit = paid + (loaned * 0.1);
                return { month: name, paid, loaned, ex, profit };
            });
            summary = summary.filter(s => s.month.toLowerCase().includes(searchTerm.toLowerCase()));
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            summary.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (sortColumn === 'month') {
                    valA = MONTH_NAMES.indexOf(a.month);
                    valB = MONTH_NAMES.indexOf(b.month);
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            return (
                <ErrorBoundary>
                    <div>
                        <div className="mb-3">
                            <label className="form-label">Year</label>
                            <select className="form-select w-auto d-inline-block" value={year} onChange={e => setYear(parseInt(e.target.value, 10))}>
                                <option value={2024}>2024</option>
                                <option value={2025}>2025</option>
                                <option value={2026}>2026</option>
                            </select>
                        </div>
                        <h2>Monthly Summary for {year}</h2>
                        <input type="text" className="form-control mb-3" placeholder="Search by month" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <div className="table-responsive">
                            <table className="table table-striped">
                                <thead>
                                    <tr>
                                        <th className={`sortable ${sortColumn === 'month' ? sortDirection : ''}`} onClick={() => handleSort('month')}>Month</th>
                                        <th className={`sortable ${sortColumn === 'paid' ? sortDirection : ''}`} onClick={() => handleSort('paid')}>Contributions (KES)</th>
                                        <th className={`sortable ${sortColumn === 'loaned' ? sortDirection : ''}`} onClick={() => handleSort('loaned')}>Loans (KES)</th>
                                        <th className={`sortable ${sortColumn === 'ex' ? sortDirection : ''}`} onClick={() => handleSort('ex')}>Expenditures (KES)</th>
                                        <th className={`sortable ${sortColumn === 'profit' ? sortDirection : ''}`} onClick={() => handleSort('profit')}>Profit (KES)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {summary.map((s, i) => (
                                        <tr key={i}>
                                            <td>{s.month}</td>
                                            <td>{s.paid.toFixed(2)}</td>
                                            <td>{s.loaned.toFixed(2)}</td>
                                            <td>{s.ex.toFixed(2)}</td>
                                            <td className={s.profit >= 0 ? 'positive' : 'negative'}>{s.profit.toFixed(2)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button className="btn btn-secondary mt-2" onClick={() => window.location.reload()}>Back</button>
                    </div>
                </ErrorBoundary>
            );
        }

        // UploadData
        function UploadData({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const handleFileChange = (e) => setFile(e.target.files[0]);
            const handleUpload = async () => {
                if (!file) {
                    setError('Please select a file');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    const batch = firebase.writeBatch(db);
                    jsonData.forEach(row => {
                        const { type, member, date, paidIn, amount } = row;
                        let docRef, data;
                        if (type === 'payment' && member && paidIn) {
                            docRef = firebase.doc(firebase.collection(db, 'payments'));
                            data = { member, date: date || new Date().toISOString().split('T')[0], paidIn: parseFloat(paidIn) };
                            batch.set(docRef, data);
                        } else if (type === 'loan' && member && amount) {
                            docRef = firebase.doc(firebase.collection(db, 'loans'));
                            data = { member, date: date || new Date().toISOString().split('T')[0], amount: parseFloat(amount) };
                            batch.set(docRef, data);
                        } else if (type === 'expenditure' && member && amount) {
                            docRef = firebase.doc(firebase.collection(db, 'expenditures'));
                            data = { member, date: date || new Date().toISOString().split('T')[0], amount: parseFloat(amount) };
                            batch.set(docRef, data);
                        }
                    });
                    await batch.commit();
                    setFile(null);
                    onSuccess();
                } catch (e) {
                    setError('Error uploading data: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Upload Data</h2>
                        {error && <div className="alert alert-danger">{error}</div>}
                        {loading && <div className="loading">Uploading...</div>}
                        <div className="mb-3">
                            <label className="form-label">Select Excel File</label>
                            <input type="file" className="form-control" accept=".xlsx,.xls" onChange={handleFileChange} disabled={loading} />
                            <p className="text-muted mt-2">Expected format: Columns - type (payment/loan/expenditure), member, date (YYYY-MM-DD optional), paidIn or amount.</p>
                        </div>
                        <button className="btn btn-success" onClick={handleUpload} disabled={!file || loading}>Upload Data</button>
                        <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                    </div>
                </ErrorBoundary>
            );
        }

        // ManageTransactions
        function ManageTransactions({ year, onDeleteSuccess, onEditSuccess }) {
            const [transactions, setTransactions] = useState([]);
            const [selected, setSelected] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('date');
            const [sortDirection, setSortDirection] = useState('desc');
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [users, setUsers] = useState([]);
            useEffect(() => {
                setLoading(true);
                Promise.all([
                    loadData('payments', []).then(p => p.filter(pp => getYear(pp.date) === year).map(pp => ({ ...pp, type: 'Payment', coll: 'payments', amount: pp.paidIn }))),
                    loadData('loans', []).then(l => l.filter(ll => getYear(ll.date) === year).map(ll => ({ ...ll, type: 'Loan', coll: 'loans', amount: ll.amount }))),
                    loadData('expenditures', []).then(e => e.filter(ee => getYear(ee.date) === year).map(ee => ({ ...ee, type: 'Expenditure', coll: 'expenditures', amount: ee.amount }))),
                    loadData('users', []).then(setUsers)
                ]).then(([p, l, e]) => {
                    setTransactions([...p, ...l, ...e].sort((a, b) => new Date(b.date) - new Date(a.date)));
                    setLoading(false);
                }).catch(err => {
                    setError('Error loading transactions: ' + err.message);
                    setLoading(false);
                    setTimeout(() => setError(''), 3000);
                });
            }, [year]);
            const toggleSelect = (id, coll) => {
                setSelected(prev => {
                    const isSelected = prev.some(s => s.id === id && s.coll === coll);
                    if (isSelected) {
                        return prev.filter(s => !(s.id === id && s.coll === coll));
                    } else {
                        return [...prev, { id, coll }];
                    }
                });
            };
            const handleDeleteSelected = async () => {
                if (selected.length === 0) {
                    setError('Select at least one transaction');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                if (!confirm(`Delete ${selected.length} transaction(s)?`)) return;
                setLoading(true);
                setError('');
                try {
                    const groups = selected.reduce((acc, { coll, id }) => {
                        if (!acc[coll]) acc[coll] = [];
                        acc[coll].push(id);
                        return acc;
                    }, {});
                    await Promise.all(Object.entries(groups).map(([coll, ids]) => deleteByIds(coll, ids)));
                    setTransactions(transactions.filter(t => !selected.some(s => s.id === t.id && s.coll === t.coll)));
                    setSelected([]);
                    onDeleteSuccess();
                } catch (e) {
                    setError('Error deleting transactions: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            const handleEdit = (trans) => {
                setEditingTransaction({ ...trans });
            };
            const handleSaveEdit = async () => {
                if (!editingTransaction.member || !editingTransaction.date || isNaN(editingTransaction.amount)) {
                    setError('Invalid data');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                setLoading(true);
                try {
                    const updates = { member: editingTransaction.member, date: editingTransaction.date };
                    if (editingTransaction.coll === 'payments') {
                        updates.paidIn = editingTransaction.amount;
                    } else {
                        updates.amount = editingTransaction.amount;
                    }
                    await updateData(editingTransaction.coll, editingTransaction.id, updates);
                    setTransactions(transactions.map(t => t.id === editingTransaction.id && t.coll === editingTransaction.coll ? { ...t, ...updates, amount: editingTransaction.amount } : t));
                    setEditingTransaction(null);
                    onEditSuccess();
                } catch (e) {
                    setError('Error updating transaction: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            let filteredTransactions = transactions.filter(t => 
                t.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.date.includes(searchTerm) ||
                (t.member || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.amount.toString().includes(searchTerm)
            );
            filteredTransactions.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (sortColumn === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (sortColumn === 'member' || sortColumn === 'type') {
                    valA = (valA || '').toLowerCase();
                    valB = (valB || '').toLowerCase();
                } else if (sortColumn === 'amount') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            if (loading) return <div className="loading">Loading...</div>;
            if (error) return <div className="alert alert-danger">{error}</div>;
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Manage Transactions for {year}</h2>
                        <input type="text" className="form-control mb-3" placeholder="Search by type, date, member, amount" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <div className="mb-3">
                            <button className="btn btn-danger" onClick={handleDeleteSelected} disabled={selected.length === 0 || loading}>
                                Delete Selected ({selected.length})
                            </button>
                            <button className="btn btn-secondary ms-2" onClick={() => setSelected([])} disabled={selected.length === 0 || loading}>
                                Clear Selection
                            </button>
                        </div>
                        <div className="table-responsive">
                            <table className="table table-striped">
                                <thead>
                                    <tr>
                                        <th className={`sortable ${sortColumn === 'type' ? sortDirection : ''}`} onClick={() => handleSort('type')}>Type</th>
                                        <th className={`sortable ${sortColumn === 'date' ? sortDirection : ''}`} onClick={() => handleSort('date')}>Date</th>
                                        <th className={`sortable ${sortColumn === 'member' ? sortDirection : ''}`} onClick={() => handleSort('member')}>Member</th>
                                        <th className={`sortable ${sortColumn === 'amount' ? sortDirection : ''}`} onClick={() => handleSort('amount')}>Amount (KES)</th>
                                        <th><input type="checkbox" checked={selected.length === filteredTransactions.length} onChange={() => {
                                            if (selected.length === filteredTransactions.length) {
                                                setSelected([]);
                                            } else {
                                                setSelected(filteredTransactions.map(t => ({ id: t.id, coll: t.coll })));
                                            }
                                        }} disabled={loading} /></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredTransactions.map((t, i) => (
                                        <tr key={i}>
                                            <td>{t.type}</td>
                                            <td>{t.date}</td>
                                            <td>{t.member || '-'}</td>
                                            <td>{(t.amount || 0).toFixed(2)}</td>
                                            <td><input type="checkbox" checked={selected.some(s => s.id === t.id && s.coll === t.coll)} onChange={() => toggleSelect(t.id, t.coll)} disabled={loading} /></td>
                                            <td><button className="btn btn-primary btn-sm" onClick={() => handleEdit(t)} disabled={loading}>Edit</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <button className="btn btn-secondary mt-3" onClick={() => window.location.reload()} disabled={loading}>Back</button>
                    </div>
                    {editingTransaction && (
                        <div className="modal fade show d-block" tabIndex="-1" role="dialog">
                            <div className="modal-dialog" role="document">
                                <div className="modal-content">
                                    <div className="modal-header">
                                        <h5 className="modal-title">Edit {editingTransaction.type}</h5>
                                        <button type="button" className="btn-close" onClick={() => setEditingTransaction(null)}></button>
                                    </div>
                                    <div className="modal-body">
                                        <div className="mb-3">
                                            <label className="form-label">Member</label>
                                            <select className="form-select" value={editingTransaction.member} onChange={e => setEditingTransaction({ ...editingTransaction, member: e.target.value })}>
                                                <option value="">Select Member</option>
                                                {users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}
                                            </select>
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Date</label>
                                            <input type="date" className="form-control" value={editingTransaction.date} onChange={e => setEditingTransaction({ ...editingTransaction, date: e.target.value })} />
                                        </div>
                                        <div className="mb-3">
                                            <label className="form-label">Amount (KES)</label>
                                            <input type="number" step="0.01" className="form-control" value={editingTransaction.amount} onChange={e => setEditingTransaction({ ...editingTransaction, amount: parseFloat(e.target.value) })} />
                                        </div>
                                    </div>
                                    <div className="modal-footer">
                                        <button type="button" className="btn btn-secondary" onClick={() => setEditingTransaction(null)}>Close</button>
                                        <button type="button" className="btn btn-primary" onClick={handleSaveEdit}>Save changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </ErrorBoundary>
            );
        }

        // Download Data
        function DownloadData({ year }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const download = async () => {
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const payments = await loadData('payments', []);
                    const loans = await loadData('loans', []);
                    const expenditures = await loadData('expenditures', []);
                    let csv = 'Members\nID,Name,Role\n';
                    users.forEach((u, i) => {
                        csv += `${i + 1},${u.name},${u.role}\n`;
                    });
                    csv += '\nPayments\nName,Date,Paid In\n';
                    payments.filter(p => getYear(p.date) === year).forEach(p => {
                        csv += `${p.member},${p.date},${p.paidIn}\n`;
                    });
                    csv += '\nLoans\nName,Date,Amount\n';
                    loans.filter(l => getYear(l.date) === year).forEach(l => {
                        csv += `${l.member},${l.date},${l.amount}\n`;
                    });
                    csv += '\nExpenditures\nName,Date,Amount\n';
                    expenditures.filter(e => getYear(e.date) === year).forEach(e => {
                        csv += `${e.member},${e.date},${e.amount}\n`;
                    });
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `welfare_data_${year}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (e) {
                    setError('Error downloading data: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Download Data for {year}</h2>
                        {error && <div className="alert alert-danger alert-dismissible">{error}</div>}
                        {loading && <div className="loading">Loading...</div>}
                        {!loading && (
                            <>
                                <button className="btn btn-success" onClick={download}>Download CSV</button>
                                <button className="btn btn-secondary ms-2" onClick={() => window.location.reload()}>Back to Dashboard</button>
                            </>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            // Ensure admin exists on first load
            useEffect(() => {
                const initializeAdmin = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const users = await loadData('users', []);
                        if (!users || users.length === 0) {
                            await addData('users', { name: 'admin', role: 'Admin', password: sha256('Ghost123') });
                        }
                        const storedUser = sessionStorage.getItem('user');
                        if (storedUser) {
                            try {
                                setUser(JSON.parse(storedUser));
                            } catch (e) {
                                console.error('Invalid session user', e);
                                sessionStorage.removeItem('user');
                            }
                        }
                    } catch (e) {
                        setError('Error initializing app: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                    } finally {
                        setLoading(false);
                    }
                };
                initializeAdmin();
            }, []);
            const handleLogin = (userData) => {
                sessionStorage.setItem('user', JSON.stringify(userData));
                setUser(userData);
            };
            const handleLogout = () => {
                sessionStorage.removeItem('user');
                setUser(null);
            };
            if (error) return <div className="alert alert-danger">{error}</div>;
            if (loading) return <div className="loading">Initializing application...</div>;
            return (
                <DatabaseInitializer>
                    <ErrorBoundary>
                        {user ? <Dashboard user={user} onLogout={handleLogout} /> : <Login onLogin={handleLogin} />}
                    </ErrorBoundary>
                </DatabaseInitializer>
            );
        }

        // Render (React 18)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>